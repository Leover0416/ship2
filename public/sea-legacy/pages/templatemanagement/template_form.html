<!-- template表单弹窗 -->
<form id="intelligent-form" lay-filter="intelligent-form" class="layui-form model-form" style="height: 700px;overflow-y: auto">
    <input name="id" type="hidden"/>
    <input name="isCustom" id="isCustom" type="hidden">
    <div id ="tenType" class="layui-form-item" style="display: none">
        <label class="layui-form-label">租户名称：</label>
        <div class="layui-input-block">
            <select name="tenants" id="tenants" lay-filter="tenantChanged" >
                <option selected='selected' value=''></option>
            </select>
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">策略名称：</label>
        <div class="layui-input-block">
            <input name="name" placeholder="请输入策略名称" type="text" class="layui-input" maxlength="255"
                   lay-verify="required" required/>
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">策略类型：</label>
        <div class="layui-input-block">
            <select name="clType" id="clType"   lay-filter="typeChanged">
                <option selected="selected" value="0">报文策略</option>
                <option  value="1">船舶类型策略</option>
                <option  value="2">船舶参数策略</option>
            </select>
        </div>
    </div>
    <div id="bwlx" >
        <div class="layui-form-item" >
            <label class="layui-form-label">报文类型：</label>
            <div id="messageTypeId" class="layui-input-block">
<!--                <div class="layui-input-inline" >-->
<!--                <input type="checkbox" name="like1[write]" lay-skin="primary" title="A类船位置信息" style="width: 150px">-->
<!--                </div>-->
<!--                <div class="layui-input-inline">-->
<!--                    <input type="checkbox" name="like1[read]" lay-skin="primary" title="A类船静态信息" style="width: 150px">-->
<!--                </div>-->
<!--                <div class="layui-input-inline">-->
<!--                    <input type="checkbox" name="like1[game]" lay-skin="primary" title="B类船信息" style="width: 150px">-->
<!--                </div>-->
<!--                <div class="layui-input-inline">-->
<!--                <input type="checkbox" name="like1[write]" lay-skin="primary" title="搜救航空器位置信息" style="width: 150px">-->
<!--                </div>-->
<!--                <div class="layui-input-inline" >-->
<!--                <input type="checkbox" name="like1[read]" lay-skin="primary" title="基站信息"style="width: 150px">-->
<!--                </div>-->
<!--                <div class="layui-input-inline">-->
<!--                    <input type="checkbox" name="like1[game]" lay-skin="primary" title="助航设备信息" style="margin-left: 50px" >-->
<!--                </div>-->
<!--                <div class="layui-input-inline">-->
<!--                    <input type="checkbox" name="like1[read]" lay-skin="primary" title="寻址消息" style="width: 150px">-->
<!--                </div>-->
<!--                <div class="layui-input-inline">-->
<!--                    <input type="checkbox" name="like1[write]" lay-skin="primary" title="广播消息" style="width: 150px">-->
<!--                </div>-->
<!--                <div class="layui-input-inline">-->
<!--                    <input type="checkbox" name="like1[read]" lay-skin="primary" title="指配/管理信息" style="width: 150px">-->
<!--                </div>-->
<!--                <div class="layui-input-inline">-->
<!--                <input type="checkbox" name="like1[game]" lay-skin="primary" title="问询消息" >-->
<!--                </div>-->
<!--                <div class="layui-input-inline">-->
<!--                    <input type="checkbox" name="like1[read]" lay-skin="primary" title="全球导航卫星系统消息">-->
<!--                </div>-->
<!--                <div class="layui-input-inline">-->
<!--                    <input type="checkbox" name="like1[game]" lay-skin="primary" title="多用途二进制消息" >-->
<!--                </div>-->
<!--                <div class="layui-input-inline">-->
<!--                    <input type="checkbox" name="like1[read]" lay-skin="primary" title="远距离位置信息">-->
<!--                </div>-->
            </div>
        </div>
    </div>
    <div id="cblx" style="display: none">
        <div class="layui-form-item" >
            <label class="layui-form-label">船舶类型：</label>
            <div class="layui-input-block">
            <div id="test12" class="demo-tree-more" style="max-height: 300px;overflow-y: auto;"></div>

            </div>
        </div>


    </div>
    <div id="cbcs" style="display: none">
        <div style="margin-left: 15px">船舶参数</div>
        <div class="layui-form-item" >

            <div class="layui-block" style="margin-top: 20px">
                <label class="layui-form-label">船舶MMSI：</label>
                <div class="layui-input-block">
                            <select name="shipId" xm-select="shipId" placeholder="请选择船舶MMSI">
                            </select>
                </div>
            </div>
            <div class="layui-block" style="margin-top: 20px">
                <label class="layui-form-label">船舶名称：</label>
                <div class="layui-input-block">
<!--                    <input  placeholder="请输入船舶名称" type="text" class="layui-input" maxlength="20" />-->
                    <select name="shipName" xm-select="shipName" placeholder="请选择船舶名称">
                    </select>
                </div>
            </div>
            <div class="layui-block" style="margin-top: 20px">
                <label class="layui-form-label">船舶IMO：</label>
                <div class="layui-input-block">
                    <select name="shipIMO" xm-select="shipIMO" placeholder="请选择船舶IMO">
                    </select>
                </div>
            </div>
        </div>
    </div>
    <div id="stationArea" class="layui-form-item">
        <label class="layui-form-label">基站/区域：</label>
        <div class="layui-input-block">
            <input type="radio" name="stationAreaTypeName" value="0" title="基站" checked lay-filter="redioChanged"/>
            <input type="radio" name="stationAreaTypeName" value="1" title="区域" lay-filter="redioChanged"/>
        </div>
    </div>
    <div id="station" style="height: 350px">
        <div class="layui-form-item" >
            <div id= "stationIds" class="layui-input-block">
<!--                <input type="checkbox" name="like1[write]" lay-skin="primary" title="老铁山" >-->
<!--                <input type="checkbox" name="like1[read]" lay-skin="primary" title="北隍城">-->
<!--                <input type="checkbox" name="like1[game]" lay-skin="primary" title="北长山" >-->
<!--                <input type="checkbox" name="like1[write]" lay-skin="primary" title="屺姆岛" >-->
<!--                <input type="checkbox" name="like1[read]" lay-skin="primary" title="曹妃甸">-->
<!--                <input type="checkbox" name="like1[game]" lay-skin="primary" title="刘公岛" >-->
            </div>
        </div>
    </div>
    <div id="area" style="display: none">
        <div class="layui-form-item" >
            <div class="layui-inline">
                <div class="layui-form-item">
                    <label class="layui-form-label">东北角：</label>
                    <div class="layui-inline">
                        <label class="layui-form-label">经度：</label>
                        <div class="layui-input-inline">
                            <input id="northeastLng" name="northeastLng" placeholder="请输入东北角经度" type="text" class="layui-input" maxlength="20"
                                    />
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label">纬度：</label>
                        <div class="layui-input-inline">
                            <input id="northeastLat" name="northeastLat" placeholder="请输入东北角纬度" type="text" class="layui-input" maxlength="20"
                                   />
                        </div>
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">西南角：</label>
                        <div class="layui-inline">
                            <label class="layui-form-label">经度：</label>
                            <div class="layui-input-inline">
                                <input id="southwestLng" name="southwestLng" placeholder="请输入西南角经度" type="text" class="layui-input" maxlength="20"
                                       />
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label">纬度：</label>
                            <div class="layui-input-inline">
                                <input id="southwestLat" name="southwestLat" placeholder="请输入西南角纬度" type="text" class="layui-input" maxlength="20"
                                       />
                            </div>
                        </div>
                </div>
            </div>
        </div>
    </div>
    <div  class="layui-form-item model-form-footer" style="position: absolute;left: 700px;top: 680px;">
        <button class="layui-btn layui-btn-primary" ew-event="closeDialog" type="button">取消</button>
        <button class="layui-btn" lay-filter="intelligent-form-submit" lay-submit>保存</button>
    </div>
</form>

<script>
    layui.use(['layer','tree','util', 'admin', 'form', 'formSelects','common'], function () {
        var layer = layui.layer;
        var admin = layui.admin;
        var form = layui.form;
        var formSelects = layui.formSelects;
        var config=layui.common;
        var tree = layui.tree;
        var util = layui.util;
        var stationData=[];
        var messageTypeData=[];
        var shipTypeData=[];
        var shipsData=[];
        var intelligentData = {};
        form.render('radio');
        form.render('checkbox');
        function queryTenant(){
            admin.reqSync('api-user/tenant/selectList', {}, function (result) {
                if(result!=undefined&&result.length>0){
                    for(var i=0;i<result.length;i++){
                        $('#tenants').append(new Option(result[i].tenantName,result[i].tenantCode));
                    }
                }

            }, 'get');
            form.render();
        }



        function queryStation(){
            admin.reqSync('station-management/shoreInfoDb/selectMaps', {}, function (data) {
                if (data!=null&&data.length>0) {
                    stationData=data;
                }

            }, 'post');
        }
        function queryMessageType(){
            admin.reqSync('api-user/MessageType/findAll', {}, function (data) {
                if (data != null && data.length > 0) {
                    messageTypeData=data;
                }
            }, 'get');
        }
        function queryShipType() {
            admin.reqSync('api-user/ShipType/getTreeData', {}, function (data) {
                if (data != null && data.length > 0) {
                    shipTypeData=data;
                }
            }, 'get');
        }
        function queryShips() {
            //船舶参数
            admin.reqSync('shipDynamicStatic-api/getShipInfo', JSON.stringify({}), function (data) {
                if (data != null && data.ships!=undefined&& data.ships.length > 0) {
                    shipsData=data.ships;
                }
            }, 'post');
        }

        //查询租户数据权限
        function getTenantData(tenantCode) {
            var clType1 = 0;
            var stationAreaType = 0;

            admin.reqSync('api-user/tenantIntelligentData/getTenantIntelligentData', {tenantCode: tenantCode}, function (result) {
                if (result != undefined &&result.clType!=undefined&&result.clType.length> 0) {
                    intelligentData = JSON.parse(result.datas);
                    intelligentData.clType=result.clType;
                    intelligentData.stationAreaType=result.stationAreaType;
                }
                if (intelligentData.clType != undefined) {
                    clType1 = intelligentData.clType;
                }
            }, 'get');


            if(tenantCode=="webapp"){

            }else {
                $('select[name=clType]').attr("disabled", "disabled");
                $('input[name=stationAreaTypeName]').attr("disabled", "disabled");
            }
            //查基站
            if(intelligentData.stationAreaType==0){
                stationAreaType=intelligentData.stationAreaType;
                if(stationData.length==0){
                    queryStation();
                }
                setStation(stationData,"",intelligentData);

            }else if (intelligentData.stationAreaType==1){ //区域
                stationAreaType=intelligentData.stationAreaType;
                setArea();
            }else {
                //没权限
            }
            //报文策略
            if (intelligentData.clType == 0) {
                $("#stationArea").show();
                if(messageTypeData.length==0){
                    queryMessageType();
                }
                setMessageType(messageTypeData,"",intelligentData);
                cl("0");
            }
            else if (intelligentData.clType == 1) {
                if(shipTypeData.length==0){
                    queryShipType();
                }
                var treeData=[];
                for(var i in shipTypeData){
                    if(intelligentData.shipType.indexOf(shipTypeData[i].id)>-1){

                        treeData.push(shipTypeData[i]);
                    }
                }
                initTree(treeData)
                cl("1");

                setArea();

//船舶类型
                $("#stationArea").show();


            } else if (intelligentData.clType == 2) {
                $("#stationArea").hide();
                //船舶参数
                // if(shipsData.length==0){
                //     queryShips();
                // }


                var roleSelectData = new Array();
                var shipNameSelectData = new Array();
                var shipIMOSelectData = new Array();
                if(intelligentData.shipMmsi!=undefined&&intelligentData.shipMmsi.length>0){
                    var smmsi=intelligentData.shipMmsi.split(",");
                    for(var i=0;i< smmsi.length;i++){
                        roleSelectData.push({name: smmsi[i], value: smmsi[i]});
                    }
                }
                if(intelligentData.shipName!=undefined&&intelligentData.shipName.length>0){
                    var sname=intelligentData.shipName.split(",");
                    for(var i in sname){
                        shipNameSelectData.push({name: sname[i], value: sname[i]});
                    }
                }
                if(intelligentData.shipIMO!=undefined&&intelligentData.shipIMO.length>0){
                    var simo=intelligentData.shipIMO.split(",");
                    for(var i in simo){
                        shipIMOSelectData.push({name: simo[i], value: simo[i]});
                    }
                }

//                     for (var i = 0; i < shipsData.length; i++) {
//                        // if(intelligentData.shipMmsi.indexOf(shipsData[i].mmsi)>-1){
//                             roleSelectData.push({name: shipsData[i].mmsi, value: shipsData[i].mmsi});
//                        // }
//                         // if(intelligentData.shipName.indexOf(shipsData[i].mmsi)>-1){
//                         //     shipNameSelectData.push({name: shipsData[i].ename, value: shipsData[i].mmsi});
//                         // }
//                         // if(intelligentData.shipIMO.indexOf(shipsData[i].mmsi)>-1){
//                         //     shipIMOSelectData.push({name: shipsData[i].mmsi, value: shipsData[i].mmsi});
//                         // }
//
//                     }


                formSelects.data('shipId', 'local', {arr: roleSelectData});
                formSelects.data('shipName', 'local', {arr: shipNameSelectData});
                formSelects.data('shipIMO', 'local', {arr: shipIMOSelectData});
                cl("2")
            }
            form.val('intelligent-form', {clType:clType1});
            $('input[name=stationAreaTypeName][value=' + stationAreaType + ']').get(0).checked = true;
            stationArea(stationAreaType);
            form.render();
        }


    function setStation(stations,type,intelligentData) {
           if(stations==undefined||stations.length==0){
               return;
           }
            var station="";
            if(type=="all"){
                for(var i in stations){
                    station+=" <input type='checkbox' name='stationName' lay-skin='primary' value='"+stations[i].shore_mmsi+"' title='"+stations[i].shore_name+"("+stations[i].shore_mmsi+")' >"
                }
            }else {
                for(var i in stations){
                    if(intelligentData.station.indexOf(stations[i].shore_mmsi)>-1){
                        station+=" <input type='checkbox' name='stationName' lay-skin='primary' value='"+stations[i].shore_mmsi+"' title='"+stations[i].shore_name+"("+stations[i].shore_mmsi+")' >";
                    }
                }
            }
        $("#stationIds").html(station)
    }
        function setArea() {
            $("#northeastLng").val(intelligentData.area==undefined?"":intelligentData.area.northeastLng);
            $("#northeastLat").val(intelligentData.area==undefined?"":intelligentData.area.northeastLat);
            $("#southwestLng").val(intelligentData.area==undefined?"":intelligentData.area.southwestLng);
            $("#southwestLat").val(intelligentData.area==undefined?"":intelligentData.area.northeastLat);
        }
        function setMessageType(messageTypeData,type,intelligentData) {
            var message = "";
            if(messageTypeData==undefined||messageTypeData.length==0){
                return;
            }
            if(type=="all"){
                for (var i in messageTypeData) {
                    message += "<div class='layui-input-inline'>" +
                        "<input type='checkbox' name='messageTypeName' value='" + messageTypeData[i].id + "' lay-skin='primary' title='" + messageTypeData[i].messageName + "'style='width: 150px'/>" +
                        "</div>"
                }
            }else {
                for (var i in messageTypeData) {
                    if (intelligentData != undefined&&intelligentData.message != undefined&&intelligentData.message.indexOf(messageTypeData[i].id) > -1) {
                        message += "<div class='layui-input-inline'>" +
                            "<input type='checkbox' name='messageTypeName' value='"+messageTypeData[i].id+"'  lay-skin='primary' title='" + messageTypeData[i].messageName + "'style='width: 150px'/>" +
                            "</div>"
                    }
                }
            }
            $("#messageTypeId").html(message);
        }

function initTree(treeData) {
    tree.render({
        elem: '#test12'
        ,data: treeData
        ,showCheckbox: true  //是否显示复选框
        ,id: 'demoId1'
        ,isJump: true //是否允许点击节点时弹出新窗口跳转
        ,click: function(obj){
            var data = obj.data;  //获取当前点击的节点数据
            layer.msg('状态：'+ obj.state + '<br>节点数据：' + JSON.stringify(data));
        }
    });
}
     var  tempData=  admin.getTempData('t_template');
        var authtenId=config.getUser().tenantCode;
        init()
function init(){
    if(tempData==undefined){
        if(authtenId=="webapp"){
            $("#tenType").show();
            queryTenant();
            queryStation();
            queryMessageType();
            setStation(stationData,"all");
            setMessageType(messageTypeData,"all");
            cl("0");
            stationArea("0");
            $("#isCustom").val("0")
        }else {
            $("#tenType").hide();
            $("#isCustom").val("1")
            getTenantData(authtenId);
        }

        form.render();
    }else {
        if(authtenId=="webapp"){
            $("#tenType").show();
            $('#tenants').attr("disabled","disabled")
            queryTenant();
            tempData.tenants=tempData.tenantCode;
        }else {
            $("#tenType").hide();
        }

        getTenantData(tempData.tenantCode);
        form.val('intelligent-form', tempData);
        setValue();
    }
}

function setValue(){
    var result=JSON.parse(tempData.datas);
    if(tempData.clType==0){
        for(var i in result.message){
            $('input[name=messageTypeName][value=' + result.message[i] + ']').get(0).checked = true;
        }
    }else if(tempData.clType==1){
        tree.setChecked('demoId1', result.shipType);

    }else if(tempData.clType==2){
         formSelects.value('shipId', result.shipMmsi);
         formSelects.value('shipName',result.shipName);
         formSelects.value('shipIMO',  result.shipIMO);
        stationArea()
    }
    if(tempData.stationAreaType==0){
        for(var i in result.station){
            $('input[name=stationAreaTypeName][value=' + result.station[i] + ']').get(0).checked = true;
        }
    }


    form.render();
}

        // 表单提交事件
        form.on('submit(intelligent-form-submit)', function (data) {
            var param={};
            var datas={};
            var cl=data.field.clType;
            var sa=$("input:radio[name='stationAreaTypeName']:checked").val();
            if(cl==0){
                var m=[];
                var boxes = $("input:checkbox[name='messageTypeName']:checked");
                for(var i=0; i< boxes.length;i++ ){
                    m.push(boxes[i].defaultValue);
                }
                datas.message=m
            }else if(cl==1){
                var ch=[];
                var checkedData = tree.getChecked('demoId1');
                for(var i=0;i<checkedData.length;i++){
                    ch.push(checkedData[i].id);
                    if(checkedData[i].children!=undefined&&checkedData[i].children.length>0){
                        for(var j=0;j<checkedData[i].children.length;j++){
                            ch.push(checkedData[i].children[j].id);
                        }
                    }
                }
                datas.shipType=ch
            }else if(cl==2){
                var shipsId = $("input[name='shipId']").val().split(",");
                var shipsName = $("input[name='shipName']").val().split(",");
                var shipsIMO = $("input[name='shipIMO']").val().split(",");
                datas.shipMmsi=shipsId
                datas.shipName=shipsName
                datas.shipIMO=shipsIMO

            }
            if(sa==0){
                var s=[];
                var sta = $("input:checkbox[name='stationName']:checked");
                for(var i=0; i< sta.length;i++  ){
                    s.push(sta[i].defaultValue);
                }
                datas.station=s
                param.stationAreaType=sa
            }else if(sa==1){
                var area={}
                area.northeastLng=$("#northeastLng").val();
                area.northeastLat=$("#northeastLat").val();
                area.southwestLng=$("#southwestLng").val();
                area.southwestLat=$("#southwestLat").val();
                datas.area=area
                param.stationAreaType=sa
            }
            param.id=data.field.id;
            param.clType=cl;
            param.name=data.field.name;
            param.datas=JSON.stringify(datas);
            param.tenantCode=authtenId=="webapp"?data.field.tenants:authtenId
            param.isCustom=data.field.isCustom
            layer.load(2);
            admin.req('api-user/intelligentData/saveOrUpdate', JSON.stringify(param), function (data) {
                layer.closeAll('loading');
                if (data.resp_code == 0) {
                    layer.msg(data.resp_msg, {icon: 1, time: config.msgTime});
                    admin.finishPopupCenter();
                } else {
                    layer.msg(data.resp_msg, {icon: 2, time: config.msgTime});
                }
            }, "POST");
             return false;
        });

        form.on('select(tenantChanged)', function (data) {
            getTenantData(data.value);
        });
        form.on('select(typeChanged)', function (data) {
            cl(data.value);
        });
        form.on('radio(redioChanged)', function (data) {
            stationArea(data.value)
        });

        function cl(value) {
            if(value==0){
                $("#bwlx").show();
                $("#cblx").hide();
                $("#cbcs").hide();
                $("#station").css("height",'300px');
            }else if (value==1){

                $("#bwlx").hide();
                $("#cblx").show();
                $("#cbcs").hide();
                $("#station").css("height",'')
            }else {
                $("#bwlx").hide();
                $("#cblx").hide();
                $("#cbcs").show();
            }
        }
        function stationArea(value) {
            if(value==0){
                $("#station").show();
                $("#area").hide();
            }else if (value==1){
                $("#station").hide();
                $("#area").show();
            }else {
                $("#station").hide();
                $("#area").hide();
            }
        }

    });
</script>