<div class="layui-card">
    <div class="layui-card-header">
        <h2 class="header-title">VDE信令信道配置</h2>
    </div>
    <div class="layui-fluid">
        <div class="layui-card">
            <div class="layui-card-body" style="padding: 15px;">
                <form class="layui-form" action="" lay-filter="ASCEdit-form">

                    <div class="layui-form-item">
                        <div class="layui-inline">
                            <label class="layui-form-label" style="width:130px;"><i style="color:#F00;font-family:serif;padding-right:5px;font-style: normal;">*</i>选择基站</label>
                            <div class="layui-input-inline">
                                <select name="shoreMmsi" id="shoreMmsiAsc" lay-filter="stationChangedAsc" lay-verify="required" >
                                    <option selected="selected" value=""></option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="layui-form-item">
                        <div class="layui-inline">
                            <label class="layui-form-label" style="width:130px;"><i style="color:#F00;font-family:serif;padding-right:5px;font-style: normal;">*</i>信道</label>
                            <div class="layui-input-inline">
                                <select name="channel" id="channel" lay-verify="required">
                                    <option selected="selected" value="">请选择</option>
                                    <option value="A">A信道</option>
                                    <option value="B">B信道</option>
                                </select>
                            </div>
                        </div>
                    </div>


                    <div class="layui-form-item">
                        <div class="layui-inline">
                            <label class="layui-form-label" style="width:130px;"><i style="color:#F00;font-family:serif;padding-right:5px;font-style: normal;">*</i>RA算法选择间隔</label>
                            <div class="layui-input-inline">
                                <input type="number" name="selectionInterval" id="selectionInterval" onKeyUp="this.value=this.value.replace(/[^\d]/g,'');" lay-verify="required" placeholder="请输入0-511" autocomplete="off" class="layui-input" oninput="if(value.length>3)value=value.slice(0,3)" >
                            </div>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <div class="layui-inline">
                            <label class="layui-form-label" style="width:130px;"><i style="color:#F00;font-family:serif;padding-right:5px;font-style: normal;">*</i>每帧最大短消息数</label>
                            <div class="layui-input-inline">
                                <input type="number" name="shortMessageCount" id="shortMessageCount" onKeyUp="this.value=this.value.replace(/[^\d]/g,'');" lay-verify="required" placeholder="请输入0-127" autocomplete="off" class="layui-input" oninput="if(value.length>3)value=value.slice(0,3)">
                            </div>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <div class="layui-inline" style="margin-left:50px;">
                            <!-- <label class="layui-form-label" style="width:120px;"></label> -->
                            <div class="layui-input-inline">
                                <div class="layui-input-block">
                                    <a class="layui-btn" lay-submit="" lay-filter="ASCEdit-submit">立即提交</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    layui.use(['form', 'table', 'util', 'common', 'admin', 'laydate'], function () {
            var $ = layui.$;
            var form = layui.form;
            var laydate = layui.laydate;
            var id = '';
            var oldData = {};
            var isFail = false;
            var admin = layui.admin;
            var config = layui.common;
            var table = layui.table;
            //var loadIndex = layer.load(1);
            //获取基站下拉列表
            getStationSelectList();

            form.on('select(stationChangedAsc)', function (data) {
                if (data.value == '') {
                    id = '';
                    $("#channel").val('')
                    $("#selectionInterval").val('');
                    $("#shortMessageCount").val('');
                    form.render('select');
                    return
                }
                admin.req('stationConfigure/vdesAscChannel/getByShoreMmsi', JSON.stringify({shoreMmsi: data.value}), function (res) {
                    if (res.resp_code == '0') {
                        oldData = res.datas;
                        if (res.datas) {
                            id = res.datas.id;
                            $("#channel").val(res.datas.channel)
                            $("#selectionInterval").val(res.datas.selectionInterval);
                            $("#shortMessageCount").val(res.datas.shortMessageCount);
                        } else {
                            id = '';
                            $("#channel").val('')
                            $("#selectionInterval").val('');
                            $("#shortMessageCount").val('');
                        }
                        form.render('select');
                    }
                }, "post")
            });

            form.on('submit(ASCEdit-submit)', function(data){
                var field = data.field;
                var a = $("#selectionInterval").val();
                var b = $("#shortMessageCount").val();

                if(a>511||a<0){
                    layer.msg("RA算法输入值不符合范围！");
                    return;
                }
                if(b>127||b<0){
                    layer.msg("消息数输入值不符合范围！");
                    return;
                }
                if(!isFail && oldData != null && isNotChange(field)){
                    layer.msg("没有任何值发生改变，无需提交");
                    return;
                }else{
                    oldData = field
                }

                var param = {
                    shoreMmsi: field.shoreMmsi,
                    channel: field.channel,
                    selectionInterval: field.selectionInterval,
                    shortMessageCount: field.shortMessageCount,
                    status: 0
                }
                var requestUrl = 'stationConfigure/vdesAscChannel/save';
                if(id != '' && id != null){
                    param.id = id;
                    requestUrl = 'stationConfigure/vdesAscChannel/update';
                }
                admin.req(requestUrl, JSON.stringify(param), function (res) {
                    if (res.resp_code == '0') {
                        isFail = false;
                        if (res.datas) {
                            id = res.datas.id;
                        }
                        layer.msg("配置成功！");
                    } else {
                        isFail = true;
                        layer.msg("配置失败！");
                    }
                }, "post");
            })

            function isNotChange (obj) {
                for(var key in obj){
                    var old = oldData[key]==null?'':oldData[key];
                    if(!oldData || obj[key] != old){
                        return false;
                    }
                }
                return true;
            }
            function getStationSelectList(){
                admin.req('station-maintain/baseStationAPI/selectAllBaseStation', "", function (res) {
                    var data = res;
                    for(var i in data){
                        if(data[i].connectionStatus=="0"){
                            $("#shoreMmsiAsc").prepend("<option  value='" + data[i].shoreMmsi + "'>" + data[i].shoreName + "</option>");
                        }else {
                            $("#shoreMmsiAsc").append("<option value='" + data[i].shoreMmsi + "' disabled='true'>" + data[i].shoreName + "(暂未连接)</option>")
                        }
                    }
                    form.render();
                },"post");

            };

    })
</script>