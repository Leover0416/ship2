<form id="driver-form" lay-filter="driver-form" class="layui-form model-form">
    <input name="id" type="hidden"/>
    <div class="layui-form-item">
        <div class="layui-block">
            <label class="layui-form-label layui-required">驱动名称</label>
            <div class="layui-input-block">
                <input type="text" placeholder="最长不能超过50个字符" lay-verify="required" name="driverName"
                       autocomplete="off" class="layui-input" maxlength="50">
            </div>
        </div>
    </div>
    <div class="layui-form-item">
        <div class="layui-block">
            <label class="layui-form-label">驱动文件</label>
            <div class="layui-input-block">
                <button type="button" class="layui-btn" id="driverFile">
                    <i class="layui-icon"></i>上传文件
                </button>
            </div>
        </div>
        <div class="layui-block">
            <div class="layui-input-block">
                <input type="hidden" id="filePath" name="filePath" value="">
                <input type="text" id="fileName" name="fileName" autocomplete="off" class="layui-input" value="未选择文件"
                       disabled style="border-style:none">
            </div>
        </div>
    </div>
    <!--    <div class="layui-form-item">-->
    <!--        <div class="layui-block">-->
    <!--            <label class="layui-form-label">驱动版本</label>-->
    <!--            <div class="layui-input-block">-->
    <!--                <input type="text" id="version" name="version" autocomplete="off" placeholder="驱动版本" class="layui-input"disabled readonly-->
    <!--                       style=" cursor:not-allowed;background:#CCCCCC;"-->
    <!--                        >-->
    <!--            </div>-->
    <!--        </div>-->
    <!--    </div>-->
    <div class="layui-form-item">
        <div class="layui-block">
            <label class="layui-form-label">备注</label>
            <div class="layui-input-block">
                <textarea id="remarks" name="remarks" rows="3" autocomplete="off" class="layui-textarea"
                          value="备注"></textarea>
            </div>
        </div>
    </div>

    <div class="layui-form-item model-form-footer" style="margin-top: 20px">
        <button class="layui-btn layui-btn-primary" ew-event="closeDialog" type="button">取消</button>
        <button class="layui-btn" lay-filter="driver-form-submit" lay-submit>保存</button>
    </div>
</form>

<script>
    layui.use(['layer', 'common', 'admin', 'form', 'upload'], function () {
        var layer = layui.layer;
        var config = layui.common;
        var admin = layui.admin;
        var form = layui.form;
        var upload = layui.upload;
        // 回显driver数据
        var driver = admin.getTempData('t_driverinfo');
        $('#driver-form').attr('method', 'POST');
        if (driver) {
            form.val('driver-form', driver);
            $('#driver-form').attr('method', 'POST');

        }
        var i = 0;
        //同时绑定多个元素，并将属性设定在元素上
        upload.render({
            elem: '#driverFile'
            , before: function () {
                i = layer.load(1, {
                    shade: [0.1, '#fff'] //0.1透明度的白色背景
                });
            }
            ,headers: {
                Authorization: 'Bearer ' + config.getToken().access_token
            }
            , exts: 'bin'
            , accept: 'file' //普通文件
            , url: config.base_server + 'driver-management/driverinfo/driverFile' //改成您自己的上传接口
            , choose: function (obj) {// 选择文件回调
                var files = obj.pushFile();
                var lastX = 0; //上传时 文件存进layui的文件上传队列，会出现重复校验第一次上传文件，设置校验删除之前历史文件
                var fileCount = 0;
                for (var x in files) {//遍历，获取最后一个文件的下标索引
                    lastX = x; //x是文件对象的唯一索引,是个字符串，例如：1612418956647-0
                    fileCount++;
                }
                if (fileCount > 1) {
                    for (var x in files) {//删除其他文件，保留最后一个文件
                        if (x != lastX) {
                            delete files[x];
                        }
                    }
                }
            }
            , done: function (res, index, upload) {
                layer.close(i);
                if (res.datas != null) {
                    $("#filePath").val(res.datas.driverFileUrl);
                    $("#fileName").val(res.datas.driverFileName);
                    // $("#version").val(res.datas.driverFileName.replace(".bin",""));
                } else {
                    layer.msg('驱动名称已存在');
                }
            }
            , error: function (e) {
                layer.close(layer.load());
            }
        })

        // 表单提交事件
        form.on('submit(driver-form-submit)', function (data) {
            layer.load(2);
            admin.req('driver-management/driverinfo/saveOrUpdate', JSON.stringify(data.field), function (data) {
                layer.closeAll('loading');
                if (data.resp_code == 0) {
                    layer.msg(data.resp_msg, {icon: 1, time: config.msgTime});
                    admin.finishPopupCenter();
                } else {
                    layer.msg(data.resp_msg, {icon: 2, time: config.msgTime});
                }
            }, "POST");
            return false;
        });

    });

</script>
